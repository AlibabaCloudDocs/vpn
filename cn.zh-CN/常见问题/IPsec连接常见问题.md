# IPsec连接常见问题 {#concept_pkd_53h_xdb .concept}

## 1. IPsec连接状态为“第一阶段协商失败”怎么办？ {#section_gjl_v3h_xdb .section}

第一阶段协商失败可能的原因大部分都与阿里云VPN网关与本地IDC内的VPN网关的第一阶段配置参数不一致有关，可能的原因如下：

-   预共享密钥不一致。

-   IKE协议版本不一致。

-   协商模式不一致。

-   LocalId或RemoteId不一致。

-   加密、认证算法不一致。

-   DH分组不一致，部分设备上需要手动指定该参数。

-   本地IDC的VPN网关设备未开启NAT穿越。


部分极端情况下，参数完全一致也无法协商成功，此时建议将两端的协商模式改为野蛮模式（aggressive）。

## 2. IPsec连接状态为“第二阶段协商失败”怎么办？ {#section_ijl_v3h_xdb .section}

IPsec连接第二阶段协商失败的可能原因有：

-   本端网段/对端网段与本地IDC的VPN网关设备中的配置不一致，部分VPN设备通过ACL的方式来实现本端网段/对端网段的设置，此时需参考相关设备的操作手册配置本端网段和对端网段。

-   加密算法或认证算法不一致。

-   DH分组不一致，部分设备需手动指定该参数。


## 3. 为什么IPsec连接状态为“第二阶段协商成功”，但VPC内的ECS实例无法访问本地IDC内的服务器？ {#section_kjl_v3h_xdb .section}

如果本地IDC内存在将公网IP作为私有IP使用的情况且ECS实例可以访问公网，需要提工单进行相关配置。否则请参考以下信息检查路由等相关配置：

-   检查VPC路由器上的路由配置。

-   检查本地IDC内的防火墙/iptables相关的设置，确认是否允许VPC的私网网段访问。


## 4. 为什么IPsec连接状态为“第二阶段协商成功”，但本地IDC内的服务器无法访问VPC内的ECS实例？ {#section_k41_w3h_xdb .section}

1.  检查本地IDC内的路由和ACL配置是否允许访问VPC的流量进入VPN隧道。

2.  检查ECS实例的安全组规则是否允许本地IDC中的私网网段访问。


## 5. 为什么IPsec连接状态为“第二阶段协商成功”，但是多网段场景下部分网段通信正常，部分网段通信不正常？ {#section_njl_v3h_xdb .section}

多网段场景下，建议使用IKE V2协议。

如果已经使用了IKE V2协议但问题仍然存在，建议检查本地IDC的VPN网关的SA状态，正常情况下只有一个SA，例如172.30.96.0/19 === 10.0.0.0/8 172.30.128.0/17。

如果存在多个SA说明本地IDC的VPN网关使用非标准的IKE V2协议，此时只能使用多个IPsec连接将各个网段连接起来。例如可以将IPsec连接：172.30.96.0/19 <=\> 10.0.0.0/8 172.30.128.0/17拆分为IPsec连接A：172.30.96.0/19 <=\> 10.0.0.0/8和IPsec连接B：172.30.96.0/19 <=\> 172.30.128.0/17。

**说明：** 拆分IPsec连接后由于两个IPsec连接需要共享第一阶段SA，所以两个IPsec连接的第一阶段协商参数需保持一致。

